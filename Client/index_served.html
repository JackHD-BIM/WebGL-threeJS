<html>
<head>
    <title>BIM Web Client</title>
    <style type="text/css">
        body {
            background-color: #CCEEEE;
            padding: 0; margin: 0;
        }
        #viewerContainer {
            height: 450px;
            width: 600px;
        }
        .boxed {
            background-color: white;
            border: 1px solid black;
            padding: 5px;
        }
        p, div {
            margin: 10px;
        }
        form {
            display: inline;
        }
    </style>
    <script src="jquery-1.6.1.min.js"></script>
    <script>
        if (console == undefined) {
            var console = {
                log: function(msg) {
                },
                error: function(msg) {
                }
            };
        }
    </script>
    <script src="Three.js"></script>
    <script src="RequestAnimationFrame.js"></script>
    <script src="ThreeJsViewer.js"></script>
    <script src="JSONListLoader.js"></script>
    <script src="Base64.js"></script>
    <script>
        var viewer;
        var host = 'http://localhost';
        function revisionUpdate(poid) {
            $('#roids').empty();
            $.ajax({url: host+'/rest/getAllRevisionsOfProject', data: 'poid='+poid, dataType: 'json',
                xhrFields: { withCredentials: true}, success: function(data){
                var select = $('#roids');
                $(data.sRevision).sort(function(r1,r2){
                    return r1.id > r2.id;
                }).each(function(i, revision){
                    $('<option />').val(revision.oid).text(revision.id).appendTo(select);
                });
            }});
        }
        function projectUpdate() {
            $('#revision').show();
            $('#poids').empty();
                $.ajax({url: host+'/rest/getAllReadableProjects', dataType: 'json',
                    xhrFields: { withCredentials: true}, success: function(data) {
                        var select = $('#poids');
                        $(data.sProject).filter(function(i,project){
                            return project.state == "ACTIVE" && project.name != "INT-Store";
                        }).sort(function(p1,p2){
                            return p1.name > p2.name;
                        }).each(function(i, project) {
                            $('<option />').val(project.oid).text(project.name).appendTo(select);
                        });
                        revisionUpdate(select.val());
                    }
                });
        }
        $(document).ready(function() {
            $('#errors').ajaxError(function(event, xhr, settings, thrown) {
                $(this).text( 'Ajax error: ' +  thrown.message);
            });
            viewer = new ThreeJsViewer();
            viewer.init($('#viewerContainer'));
            projectUpdate();
            viewer.onClick = function(id) {
                if (id==null) {
                    $('#selection').html('nothing');
                    return;
                }
                $.ajax({
                    url: host+'/rest/getDataObjectByGuid', dataType: 'json',
                    data: 'roid='+$('#roids').val()+'&guid='+id,
                    xhrFields: { withCredentials: true},
                    success: function(data){
                        $('#selection').html(id + ' - ' + data.sDataObject.name + ' - ' + data.sDataObject.type);
                    }
                });
            };
            viewer.animate();
            $('#poids').change(function() {
                revisionUpdate($(this).val());
            });
            $('#revision').submit(function(){
                $.ajax({
                    url: host+'/rest/download',
                    data: 'roid='+$(this.roids).val()+'&serializerName=ThreeJs&sync=true&showOwn=true',
                    xhrFields: { withCredentials: true},
                    success: function(data) {
                        viewer.clearModel();
                        $.ajax({
                            url: host+'/rest/getDownloadData',
                            dataType: 'json',
                            data: 'actionId=' + data,
                            xhrFields: { withCredentials: true},
                            success: function(model) {
                                viewer.loadSerializedModel(Base64.decode(model.sCheckoutResult.file));
                            }
                        });
                        // viewer.loadModel('/rest/downloadBinary?actionId=' + data);
                    }
                });
                return false;
            });
        });
    </script>
</head>
<body>
<div>
<form id="revision" class="boxed" style="display: none;">
    <select id="poids"></select>
    <select id="roids"></select>
    <input type="submit" value="Show" />
</form>
</div>
<div id="viewerContainer"></div>
<p id="errors"></p>
<p class="boxed">
    selected: <span id="selection">nothing</span></p>
</body>
</html>
